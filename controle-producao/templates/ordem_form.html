{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-primary text-white">
        <h3>{{ title }}</h3>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for(request.endpoint, ordem_id=ordem.id) if ordem else url_for('nova_ordem') }}">
            {{ form.hidden_tag() }}

            <!-- ========================================================= -->
            <!-- ASSOCIAÇÃO E DEPARTAMENTO -->
            <!-- ========================================================= -->
             <fieldset class="border p-3 mb-3">
                <legend class="float-none w-auto px-3">Associação e Departamento</legend>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        {{ form.os.label(class="form-label") }}
                        {{ form.os(id="os-select", class="form-select" + (" is-invalid" if form.os.errors else "")) }}
                        {% if form.os.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.os.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.departamento.label(class="form-label") }}
                        {{ form.departamento(class="form-select" + (" is-invalid" if form.departamento.errors else "")) }}
                        {% if form.departamento.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.departamento.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-3 mb-3">
                        {{ form.data_fechamento.label(class="form-label") }}
                        {{ form.data_fechamento(class="form-control" + (" is-invalid" if form.data_fechamento.errors else ""), type="date") }}
                        {% if form.data_fechamento.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.data_fechamento.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-3 mb-3">
                        {{ form.status.label(class="form-label") }}
                        {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else "")) }}
                        {% if form.status.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.status.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                </div>
            </fieldset>
            <!-- ========================================================= -->
            <!-- CABEÇALHO -->
            <!-- ========================================================= -->
            <fieldset class="border p-3 mb-3">
                <legend class="float-none w-auto px-3">Cabeçalho</legend>
                {{ form.tipo_op(type="hidden") }}
                {{ form.codigo(type="hidden") }}
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Nº Sequencial</label>
                        <input type="text" class="form-control" value="{{ ordem.numero_sequencial if ordem else proximo_numero }}" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.tipo_contrato.label(class="form-label") }}
                        {{ form.tipo_contrato(class="form-select" + (" is-invalid" if form.tipo_contrato.errors else "")) }}
                        {% if form.tipo_contrato.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.tipo_contrato.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.cliente.label(class="form-label") }}
                        {{ form.cliente(id="cliente-input", class="form-control" + (" is-invalid" if form.cliente.errors else "")) }}
                        {% if form.cliente.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.cliente.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </fieldset>

            <!-- ========================================================= -->
            <!-- DETALHES DO PRODUTO -->
            <!-- ========================================================= -->
            <fieldset class="border p-3 mb-3">
                <legend class="float-none w-auto px-3">Detalhes do Produto (Busca Part Number)</legend>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.part_number_produto.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.part_number_produto(id="codigo-busca-input", class="form-control" + (" is-invalid" if form.part_number_produto.errors else ""), placeholder="Digite ou pesquise o Part Number") }}
                            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#searchProductModal">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        {% if form.part_number_produto.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.part_number_produto.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                        <div id="descricao-produto" class="form-text mt-2"></div>
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.quantidade.label(class="form-label") }}
                        {{ form.quantidade(class="form-control" + (" is-invalid" if form.quantidade.errors else "")) }}
                        {% if form.quantidade.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.quantidade.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.largura.label(class="form-label") }}
                        {{ form.largura(class="form-control" + (" is-invalid" if form.largura.errors else "")) }}
                        {% if form.largura.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.largura.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.comprimento.label(class="form-label") }}
                        {{ form.comprimento(class="form-control" + (" is-invalid" if form.comprimento.errors else "")) }}
                        {% if form.comprimento.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.comprimento.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.pe_direito.label(class="form-label") }}
                        {{ form.pe_direito(class="form-control" + (" is-invalid" if form.pe_direito.errors else "")) }}
                        {% if form.pe_direito.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.pe_direito.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </fieldset>

            <!-- ========================================================= -->
            <!-- DATAS E PRAZOS -->
                        <!-- ========================================================= -->
            <fieldset class="border p-3 mb-3">
                <legend class="float-none w-auto px-3">Datas e Prazos</legend>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        {{ form.data_emissao.label(class="form-label") }}
                        {{ form.data_emissao(class="form-control" + (" is-invalid" if form.data_emissao.errors else ""), type="date") }}
                        {% if form.data_emissao.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.data_emissao.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.data_inicio_previsto.label(class="form-label") }}
                        {{ form.data_inicio_previsto(class="form-control" + (" is-invalid" if form.data_inicio_previsto.errors else ""), type="date") }}
                        {% if form.data_inicio_previsto.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.data_inicio_previsto.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.data_termino_previsto.label(class="form-label") }}
                        {{ form.data_termino_previsto(class="form-control" + (" is-invalid" if form.data_termino_previsto.errors else ""), type="date") }}
                        {% if form.data_termino_previsto.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.data_termino_previsto.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.data_carregamento.label(class="form-label") }}
                        {{ form.data_carregamento(class="form-control" + (" is-invalid" if form.data_carregamento.errors else ""), type="date") }}
                        {% if form.data_carregamento.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.data_carregamento.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        {{ form.setor.label(class="form-label") }}
                        {{ form.setor(class="form-control" + (" is-invalid" if form.setor.errors else "")) }}
                        {% if form.setor.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.setor.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </fieldset>

            <!-- ========================================================= -->
            <!-- ROMANEIO PARA PRODUÇÃO -->
            <!-- ========================================================= -->
            <fieldset class="border p-3 mb-3">
                <legend class="float-none w-auto px-3">Romaneio para Produção</legend>
                <div id="romaneio-list">
                    {% for item in form.romaneios %}
                    <div class="row align-items-end mb-2 dynamic-item" data-type="romaneio">
                        <div class="col-md-2">
                            {{ item.id_item(class="form-control" + (" is-invalid" if item.id_item.errors else ""), placeholder="ID") }}
                            {% if item.id_item.errors %}
                            <div class="invalid-feedback d-block">{% for error in item.id_item.errors %}<span>{{ error }}</span>{% endfor %}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                {{ item.descricao(class="form-control romaneio-descricao" + (" is-invalid" if item.descricao.errors else ""), placeholder="Descrição") }}
                                <button class="btn btn-outline-secondary search-romaneio-btn" type="button">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            {% if item.descricao.errors %}
                            <div class="invalid-feedback d-block">{% for error in item.descricao.errors %}<span>{{ error }}</span>{% endfor %}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-2">
                            {{ item.quantidade(class="form-control" + (" is-invalid" if item.quantidade.errors else ""), placeholder="Qnt") }}
                            {% if item.quantidade.errors %}
                            <div class="invalid-feedback d-block">{% for error in item.quantidade.errors %}<span>{{ error }}</span>{% endfor %}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            {{ item.materia_prima_utilizada(class="form-control" + (" is-invalid" if item.materia_prima_utilizada.errors else ""), placeholder="Matéria Prima") }}
                            {% if item.materia_prima_utilizada.errors %}
                            <div class="invalid-feedback d-block">{% for error in item.materia_prima_utilizada.errors %}<span>{{ error }}</span>{% endfor %}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm w-100 remove-item">Remover</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
              <button type="button" class="btn btn-success mt-2 add-item" data-target="romaneio-list">
                  <i class="bi bi-plus-circle-fill"></i> Adicionar Linha de Romaneio
              </button>
            </fieldset>

            <!-- ========================================================= -->
            <!-- CONTROLE DE PRODUÇÃO -->
            <!-- ========================================================= -->
            <fieldset class="border p-3 mb-3">
                <legend class="float-none w-auto px-3">Controle de Produção</legend>
                <div id="producao-list">
                    {% for item in form.controles_producao %}
                    <div class="dynamic-item pb-3 mb-3 border-bottom" data-type="producao">

                        {{ item.turno(type="hidden") }}
                        {{ item.maquina(type="hidden") }}
                        {{ item.qualidade(type="hidden") }}

                        <div class="row align-items-end mb-2">
                            <div class="col-md-3">
                                {{ item.departamento.label(class="form-label") }}
                                {{ item.departamento(class="form-select cp-departamento" + (" is-invalid" if item.departamento.errors else "")) }}
                                {% if item.departamento.errors %}
                                <div class="invalid-feedback d-block">{% for error in item.departamento.errors %}<span>{{ error }}</span>{% endfor %}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-4">
                                {{ item.processo.label(class="form-label") }}
                                {{ item.processo(class="form-select cp-processo" + (" is-invalid" if item.processo.errors else "")) }}
                                {% if item.processo.errors %}
                                <div class="invalid-feedback d-block">{% for error in item.processo.errors %}<span>{{ error }}</span>{% endfor %}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-3">
                                {{ item.operador.label(class="form-label") }}
                                {{ item.operador(class="form-control" + (" is-invalid" if item.operador.errors else "")) }}
                                {% if item.operador.errors %}
                                <div class="invalid-feedback d-block">{% for error in item.operador.errors %}<span>{{ error }}</span>{% endfor %}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-danger btn-sm w-100 remove-item">Remover</button>
                            </div>
                        </div>

                        <div class="row align-items-end mb-2">
                            <div class="col-md-3">
                                {{ item.data_inicio.label(class="form-label") }}
                                {{ item.data_inicio(class="form-control" + (" is-invalid" if item.data_inicio.errors else ""), type="date") }}
                            </div>
                            <div class="col-md-3">
                                {{ item.hora_inicio.label(class="form-label") }}
                                {{ item.hora_inicio(class="form-control" + (" is-invalid" if item.hora_inicio.errors else ""), type="time") }}
                            </div>
                            <div class="col-md-3">
                                {{ item.data_termino.label(class="form-label") }}
                                {{ item.data_termino(class="form-control" + (" is-invalid" if item.data_termino.errors else ""), type="date") }}
                            </div>
                            <div class="col-md-3">
                                {{ item.hora_termino.label(class="form-label") }}
                                {{ item.hora_termino(class="form-control" + (" is-invalid" if item.hora_termino.errors else ""), type="time") }}
                            </div>
                        </div>

                        <div class="row align-items-end mb-2">
                            <div class="col-md-3">
                                {{ item.data_pausa.label(class="form-label") }}
                                {{ item.data_pausa(class="form-control" + (" is-invalid" if item.data_pausa.errors else ""), type="date") }}
                            </div>
                            <div class="col-md-9"> {{ item.motivo_pausa.label(class="form-label") }}
                                {{ item.motivo_pausa(class="form-control" + (" is-invalid" if item.motivo_pausa.errors else "")) }}
                            </div>
                        </div>

                        <div class="row align-items-end">
                            <div class="col-md-12">
                                {{ item.obs_prod.label(class="form-label") }}
                                {{ item.obs_prod(class="form-control" + (" is-invalid" if item.obs_prod.errors else ""), rows="2") }}
                            </div>
                        </div>

                    </div>
                    {% endfor %}
                </div>
              <button type="button" class="btn btn-info mt-2 add-item" data-target="producao-list">
                  <i class="bi bi-plus-circle-fill"></i> Adicionar Etapa de Produção
              </button>
            </fieldset>

            <!-- ========================================================= -->
            <!-- BOTÃO SALVAR -->
            <!-- ========================================================= -->
            <div class="d-grid gap-2 mt-4">
                {{ form.submit(class="btn btn-primary btn-lg") }}
            </div>
        </form>
    </div>
</div>

<!-- ========================================================= -->
<!-- MODAIS -->
<!-- ========================================================= -->
<!-- Modal de Pesquisa de Produto Principal -->
<div class="modal fade" id="searchProductModal" tabindex="-1" aria-labelledby="searchProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchProductModalLabel">Pesquisar Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="modal-search-input" class="form-control" placeholder="Digite o Part Number, SKU ou Descrição para buscar...">
                    <button class="btn btn-primary" type="button" id="modal-search-button">Pesquisar</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Part Number</th>
                                <th>Descrição</th>
                                <th>SKU</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="modal-results-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pesquisa para Romaneio -->
<div class="modal fade" id="searchRomaneioModal" tabindex="-1" aria-labelledby="searchRomaneioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchRomaneioModalLabel">Pesquisar Produto para Romaneio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="romaneio-modal-search-input" class="form-control" placeholder="Digite o Part Number, SKU ou Descrição para buscar...">
                    <button class="btn btn-primary" type="button" id="romaneio-modal-search-button">Pesquisar</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Part Number</th>
                                <th>Descrição</th>
                                <th>SKU</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="romaneio-modal-results-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // ===================================================================
    // === SCRIPT 1: Preenchimento automático ao selecionar OS ===
    // ===================================================================
    const osSelect = document.getElementById('os-select');
    const clienteInput = document.getElementById('cliente-input');

    if (osSelect && clienteInput) {
        osSelect.addEventListener('change', async function() {
            const osId = this.value;

            if (!osId) {
                clienteInput.value = '';
                return;
            }

            try {
                const response = await fetch(`/api/os/info?os_id=${osId}`);
                const data = await response.json();

                if (response.ok) {
                    clienteInput.value = data.cliente || '';
                } else {
                    console.error('Erro ao buscar dados da OS:', data.error);
                    clienteInput.value = 'Erro: OS não encontrada';
                }
            } catch (error) {
                console.error('Erro na requisição da API da OS:', error);
                clienteInput.value = 'Erro de conexão';
            }
        });
    }

    // ===================================================================
    // === SCRIPT 2: Lógica para o Modal de Pesquisa de Produto Principal ===
    // ===================================================================
    const modalElement = document.getElementById('searchProductModal');
    const codigoBuscaInput = document.getElementById('codigo-busca-input');
    const descricaoDiv = document.getElementById('descricao-produto');

    if (modalElement && codigoBuscaInput) {
        const modalSearchInput = document.getElementById('modal-search-input');
        const modalSearchButton = document.getElementById('modal-search-button');
        const resultsTbody = document.getElementById('modal-results-tbody');

        async function performSearch() {
            const query = modalSearchInput.value.trim();
            if (query.length < 2) {
                resultsTbody.innerHTML = '<tr><td colspan="4" class="text-center">Digite pelo menos 2 caracteres...</td></tr>';
                return;
            }
            resultsTbody.innerHTML = '<tr><td colspan="4" class="text-center">Buscando...</td></tr>';

            try {
                const response = await fetch(`/api/produtos/search?q=${query}`);
                const produtos = await response.json();
                resultsTbody.innerHTML = '';
                if (produtos.length > 0) {
                    produtos.forEach(p => {
                        const row = `
                            <tr>
                                <td>${p.part_number}</td>
                                <td>${p.descricao}</td>
                                <td>${p.sku || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-sm btn-success select-product-btn"
                                            data-part-number="${p.part_number}"
                                            data-bs-dismiss="modal">Selecionar</button>
                                </td>
                            </tr>`;
                        resultsTbody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    resultsTbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum produto encontrado.</td></tr>';
                }
            } catch (error) {
                resultsTbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Erro na busca.</td></tr>';
            }
        }

        modalSearchButton.addEventListener('click', performSearch);
        modalSearchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });

        resultsTbody.addEventListener('click', function(e) {
            if (e.target.classList.contains('select-product-btn')) {
                const selectedPartNumber = e.target.dataset.partNumber;
                codigoBuscaInput.value = selectedPartNumber;
                codigoBuscaInput.dispatchEvent(new Event('blur'));
            }
        });
    }

    // ===================================================================
    // === SCRIPT 3: Lógica para buscar descrição do produto ===
    // ===================================================================
    if (codigoBuscaInput && descricaoDiv) {
        codigoBuscaInput.addEventListener('blur', async function() {
            const partNumber = this.value.trim();
            descricaoDiv.textContent = '';
            descricaoDiv.className = 'form-text mt-2';
            if (!partNumber) return;
            descricaoDiv.textContent = 'Buscando...';
            try {
                const response = await fetch(`/api/produto/info?part_number=${partNumber}`);
                const data = await response.json();
                if (response.ok) {
                    descricaoDiv.textContent = `Descrição: ${data.descricao}`;
                    descricaoDiv.classList.add('text-success', 'fw-bold');
                } else {
                    descricaoDiv.textContent = data.error;
                    descricaoDiv.classList.add('text-danger');
                }
            } catch (error) {
                descricaoDiv.textContent = 'Erro ao buscar o produto.';
            }
        });
    }

    // ===================================================================
    // === SCRIPT 4: Lógica para o Modal de Pesquisa de Produto do Romaneio ===
    // ===================================================================
    const romaneioModalElement = document.getElementById('searchRomaneioModal');
    let currentRomaneioInput = null;

    if (romaneioModalElement) {
        const romaneioModalSearchInput = document.getElementById('romaneio-modal-search-input');
        const romaneioModalSearchButton = document.getElementById('romaneio-modal-search-button');
        const romaneioResultsTbody = document.getElementById('romaneio-modal-results-tbody');
        const romaneioModal = new bootstrap.Modal(romaneioModalElement);

        // Abrir modal ao clicar no botão de busca do romaneio
        document.addEventListener('click', function(e) {
            if (e.target.closest('.search-romaneio-btn')) {
                const btn = e.target.closest('.search-romaneio-btn');
                const inputGroup = btn.closest('.input-group');
                currentRomaneioInput = inputGroup.querySelector('.romaneio-descricao');
                romaneioModalSearchInput.value = '';
                romaneioResultsTbody.innerHTML = '';
                romaneioModal.show();
            }
        });

        async function performRomaneioSearch() {
            const query = romaneioModalSearchInput.value.trim();
            if (query.length < 2) {
                romaneioResultsTbody.innerHTML = '<tr><td colspan="4" class="text-center">Digite pelo menos 2 caracteres...</td></tr>';
                return;
            }
            romaneioResultsTbody.innerHTML = '<tr><td colspan="4" class="text-center">Buscando...</td></tr>';

            try {
                const response = await fetch(`/api/produtos/search?q=${query}`);
                const produtos = await response.json();
                romaneioResultsTbody.innerHTML = '';
                if (produtos.length > 0) {
                    produtos.forEach(p => {
                        const row = `
                            <tr>
                                <td>${p.part_number}</td>
                                <td>${p.descricao}</td>
                                <td>${p.sku || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-sm btn-success select-romaneio-product-btn"
                                            data-descricao="${p.descricao}">Selecionar</button>
                                </td>
                            </tr>`;
                        romaneioResultsTbody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    romaneioResultsTbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum produto encontrado.</td></tr>';
                }
            } catch (error) {
                romaneioResultsTbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Erro na busca.</td></tr>';
            }
        }

        romaneioModalSearchButton.addEventListener('click', performRomaneioSearch);
        romaneioModalSearchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') performRomaneioSearch(); });

        romaneioResultsTbody.addEventListener('click', function(e) {
            if (e.target.classList.contains('select-romaneio-product-btn')) {
                const selectedDescricao = e.target.dataset.descricao;
                if (currentRomaneioInput) {
                    currentRomaneioInput.value = selectedDescricao;
                }
                romaneioModal.hide();
            }
        });
    }

    // ===================================================================
    // === SCRIPT 5: Lógica para adicionar/remover linhas dinâmicas ===
    // ===================================================================
    const cardBody = document.querySelector('.card-body');
    if (cardBody) {
        cardBody.addEventListener('click', function(e) {
            // Adicionar item
            if (e.target && e.target.matches('.add-item')) {
                const targetId = e.target.dataset.target;
                const list = document.getElementById(targetId);
                if (!list || !list.children.length) return;
                const templateItem = list.children[0];
                const itemType = templateItem.dataset.type;
                const index = Date.now();
                const newItem = templateItem.cloneNode(true);

                newItem.querySelectorAll('input, select, textarea').forEach(el => {
                    if (el.tagName === 'SELECT') el.selectedIndex = 0;
                    else if (el.type !== 'hidden') el.value = '';
                    el.classList.remove('is-invalid');
                    const errorDiv = el.closest('.mb-2,.mb-3')?.querySelector('.invalid-feedback');
                    if (errorDiv) errorDiv.innerHTML = '';
                });

                newItem.querySelectorAll('input, select, textarea, label').forEach(el => {
                    let namePrefix;
                    if (itemType === 'romaneio') {
                        namePrefix = 'romaneios';
                    } else if (itemType === 'producao') {
                        namePrefix = 'controles_producao';
                    } else {
                        return;
                    }

                    const idRegex = new RegExp(`(${namePrefix})-(\\d+|__prefix__)-`);
                    const nameRegex = new RegExp(`(${namePrefix})-\\d+-`);
                    const replacement = `$1-${index}-`;

                    if (el.name) el.name = el.name.replace(nameRegex, replacement);
                    if (el.id) el.id = el.id.replace(idRegex, replacement);
                    if (el.htmlFor) el.htmlFor = el.htmlFor.replace(idRegex, replacement);
                });
                list.appendChild(newItem);
            }
            // Remover item
            if (e.target && e.target.matches('.remove-item')) {
                const item = e.target.closest('.dynamic-item');
                if (item.parentElement.getElementsByClassName('dynamic-item').length > 1) {
                    item.remove();
                } else {
                    alert('Pelo menos uma linha é necessária.');
                }
            }
        });
    }

    // ===================================================================
    // === SCRIPT 6: Lógica para Dropdown Dependente (Processo) ===
    // ===================================================================

    // (Este script usa o 'cardBody' definido no SCRIPT 5)
    if (cardBody) {

        // 1. O mapa de dados que você definiu
        const processosPorDepartamento = {
            'Metalúrgica': ['Solda', 'Ponteamento', 'Corte/Fixação', 'Serra', 'Plasma', '5S'],
            'Lavagem Lona': ['Lavagem Lona', '5S'],
            'Confecção Lona': ['Confecção Lona', '5S'],
            'Logística': ['Carga e Descarga', 'Armazenamento', 'Picking']
        };

        // 2. A função que atualiza o dropdown de Processo
        function atualizarProcessos(deptoSelect) {
            const selectedDepto = deptoSelect.value;

            // Encontra o dropdown 'processo' na *mesma linha*
            // (Usamos .dynamic-item que você definiu no SCRIPT 5)
            const parentItem = deptoSelect.closest('.dynamic-item');
            if (!parentItem) return;

            const processoSelect = parentItem.querySelector('.cp-processo');
            if (!processoSelect) return;

            // Guarda o valor que estava selecionado (para o caso de edição)
            const valorAntigo = processoSelect.value;

            // Limpa opções antigas
            processoSelect.innerHTML = '';

            // Busca a nova lista de processos
            const processos = processosPorDepartamento[selectedDepto];

            if (processos && processos.length > 0) {
                // Adiciona a opção padrão "Selecione"
                processoSelect.add(new Option('Selecione um processo', ''));

                // Adiciona as novas opções
                processos.forEach(function(processo) {
                    processoSelect.add(new Option(processo, processo));
                });
            } else {
                // Caso o departamento seja "Selecione" ou não tenha processos
                processoSelect.add(new Option('Selecione um departamento primeiro', ''));
            }

            // Tenta resselecionar o valor antigo (se ele ainda existir na nova lista)
            processoSelect.value = valorAntigo;
        }

        // 3. O "Ouvinte" de eventos
        // Usamos delegação de evento no 'cardBody' porque as linhas são dinâmicas
        cardBody.addEventListener('change', function(e) {
            // Se o item alterado for um dropdown de departamento...
            if (e.target.matches('.cp-departamento')) {
                atualizarProcessos(e.target);
            }
        });

        // 4. Garantir que os campos já existentes (ao editar) carreguem corretamente
        // (Roda 1 vez quando a página carrega)
        document.querySelectorAll('.cp-departamento').forEach(function(deptoSelect) {
            atualizarProcessos(deptoSelect);
        });
    }

});
</script>
{% endblock %}
